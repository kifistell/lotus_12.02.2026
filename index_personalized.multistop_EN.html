<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>East Kazakhstan Travel Guide</title>

    <!-- –û–°–ù–û–í–ù–û–ô CSS -->
    <link rel="stylesheet" href="quide_1.fixed.full.v2.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">



</head>

<body>

    <!-- ===== HEADER ===== -->
    <div class="wrapper">
        <svg class="wave" viewBox="0 0 1440 150" preserveAspectRatio="none">
            <path d="M0,30 C360,120 1080,0 1440,60 L1440,150 L0,150 Z" fill="#ffffff"></path>
        </svg>

        <header class="container">
            <div class="header-top">
                <img src="lotus.png" class="LOGO">
                <nav class="main-nav">
                    <ul>
                        <li><a href="#map12345">Routes</a></li>
                        <li><a href="#wx">Weather</a></li>
                        <li><a href="#info">What to see</a></li>
                        <li><a href="profile_1_v2.html">Profile</a></li>
                        <li class="theme-toggle">
                            <button id="themeToggle">Theme</button>
                        </li>
                        <li class="btn"><a href="tel:+77711623673">Contact a guide</a></li>
                        <li class="lang" id="langSwitch">
                            <button class="lang-btn" type="button" aria-haspopup="true" aria-expanded="false" aria-label="–¢—ñ–ª–¥—ñ —Ç–∞“£–¥–∞—É">
                                ENG <span class="lang-caret" aria-hidden="true">‚ñæ</span>
                            </button>

                            <div class="lang-menu" role="menu" aria-label="Languages">
                                <a class="lang-item" role="menuitem" href="index_personalized.multistop.html" hreflang="ru">Russion</a>
                                <a class="lang-item " role="menuitem" href="index_personalized.multistop_KZ.html" hreflang="kk">Kazakh</a>
                                <a class="lang-item is-active" role="menuitem" href="index_personalized.multistop_EN.html" hreflang="en">English</a>
                            </div>
                        </li>

                    </ul>
                </nav>

            </div>
            <h1>EXPLORE EAST KAZAKHSTAN</h1>


        </header>
    </div>

    <!-- ===== HERO ===== -->
    <div class="second">
        <div class="hero container">
            <img class="map" id="heroMap" src="map.png" alt="Map of East Kazakhstan">

            <div class="hero-info">
                <h3>Your guide to East Kazakhstan</h3>
                <p id="green">Travel across East Kazakhstan</p>

                <p>
                    Every trip is a story.
                    We‚Äôll help you see East Kazakhstan the way only locals know it.
                </p>

                <p>
                    Plan trips across East Kazakhstan with clear guidance: what to see, how to get there, when to go, and how much time to set aside.
                    Everything is in one place ‚Äî fast, convenient, and to the point.
                </p>
            </div>

            <img class="air" src="air.png" alt="">
        </div>

        <!-- –í–ê–ñ–ù–û: —Å–±—Ä–æ—Å float/–æ–±—Ç–µ–∫–∞–Ω–∏—è, —á—Ç–æ–±—ã –∫–∞—Ä—É—Å–µ–ª—å –Ω–∞—á–∏–Ω–∞–ª–∞—Å—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ -->
        <div style="clear: both;"></div>

        <section class="carusel">
            <div class="main_cro container">
                <div class="events-slider no-arrows">
                    <div class="events-window">
                        <div class="events-track">

                            <div class="card"><img src="katon-plato.jpg" alt="Photo"></div>
                            <div class="card"><img src="katon.jpeg" alt="Photo"></div>
                            <div class="card"><img src="katon-rika.jpg" alt="Photo"></div>
                            <div class="card"><img src="liys.png" alt="Photo"></div>
                            <div class="card"><img src="goluboyozero.jpeg" alt="Photo"></div>
                            <div class="card"><img src="tursugyn.jpg" alt="Photo"></div>
                            <div class="card"><img src="katon-plato.jpg" alt="Photo"></div>
                            <div class="card"><img src="osyl.jpeg" alt="Photo"></div>
                            <div class="card"><img src="beluha.png" alt="Photo"></div>
                            <div class="card"><img src="priirtysh.jpg" alt="Photo"></div>
                            <div class="card"><img src="vodopad.jpeg" alt="Photo"></div>
                            <div class="card"><img src="ozera.jpeg" alt="Photo"></div>

                            <div class="card"><img src="sibiny_1.jpeg" alt="Photo"></div>
                            <div class="card"><img src="sibiny_2.jpeg" alt="Photo"></div>
                            <div class="card"><img src="turgen.jpg" alt="Photo"></div>
                            <div class="card"><img src="zakat.jpg" alt="Photo"></div>
                            <div class="card"><img src="krasivo.jpeg" alt="Photo"></div>
                            <div class="card"><img src="sibiny_1.jpeg" alt="Photo"></div>
                            <div class="card"><img src="gorakrasivo.jpeg" alt="Photo"></div>


                        </div>
                    </div>
                </div>

                <div class="nothero-info">
                    <h2>Where your journey begins</h2>
                    <p>Choose a direction ‚Äî and start your journey across East Kazakhstan.</p>
                </div>
            </div>
        </section>
    </div>


    <section class="wx-screen" id="wx">
        <div class="container wx-wrap">
            <div class="wx-top">
                <div>
                    <div class="wx-kicker">Weather</div>
                    <h2 class="wx-title">East Kazakhstan</h2>
                </div>

                <div class="wx-controls">
                    <button class="wx-collapse" id="wxCollapse" aria-expanded="true" title="Collapse/expand">
                        <span class="wx-chev" aria-hidden="true"></span>
                    </button>

                    <div class="wx-select-wrap">
                        <select class="wx-select" id="wxRegion"></select>
                    </div>

                    <button class="wx-btn" id="wxReload" type="button">Refresh</button>
                </div>
            </div>

            <div class="wx-meta" id="wxMeta">Loading‚Ä¶</div>

            <div class="wx-panel" id="wxPanel">
                <div class="wx-grid">
                    <!-- 1: UV -->
                    <div class="wx-card" data-card="uv">
                        <div class="wx-card-head">
                            <div class="wx-label">UV</div>
                            <div class="wx-big" id="uvText">‚Äî</div>
                        </div>

                        <div class="wx-gauge">
                            <svg viewBox="0 0 120 80" class="wx-gsvg">
                                <path class="wx-track" d="M10 70 A50 50 0 0 1 110 70" />
                                <path class="wx-prog" d="M10 70 A50 50 0 0 1 110 70" />
                                <circle class="wx-dot" cx="10" cy="70" r="5" />
                            </svg>
                            <div class="wx-sub" id="uvSub">‚Äî</div>
                        </div>
                    </div>

                    <!-- 2: Humidity -->
                    <div class="wx-card" data-card="hum">
                        <div class="wx-card-head">
                            <div class="wx-label">Humidity</div>
                            <div class="wx-big" id="humText">‚Äî</div>
                        </div>

                        <div class="wx-gauge">
                            <svg viewBox="0 0 120 80" class="wx-gsvg">
                                <path class="wx-track" d="M10 70 A50 50 0 0 1 110 70" />
                                <path class="wx-prog" d="M10 70 A50 50 0 0 1 110 70" />
                                <circle class="wx-dot" cx="10" cy="70" r="5" />
                            </svg>
                            <div class="wx-sub">üíß</div>
                        </div>
                    </div>

                    <!-- 3: Feels like -->
                    <div class="wx-card" data-card="feel">
                        <div class="wx-card-head">
                            <div class="wx-label">Feels like</div>
                            <div class="wx-big" id="feelText">‚Äî</div>
                        </div>

                        <div class="wx-gauge">
                            <svg viewBox="0 0 120 80" class="wx-gsvg">
                                <path class="wx-track" d="M10 70 A50 50 0 0 1 110 70" />
                                <path class="wx-prog" d="M10 70 A50 50 0 0 1 110 70" />
                                <circle class="wx-dot" cx="10" cy="70" r="5" />
                            </svg>
                            <div class="wx-sub" id="feelSub">‚Äî</div>
                        </div>
                    </div>

                    <!-- 4: Wind -->
                    <div class="wx-card" data-card="wind">
                        <div class="wx-card-head">
                            <div class="wx-label">Wind</div>
                            <div class="wx-big" id="windText">‚Äî</div>
                        </div>

                        <div class="wx-compass">
                            <div class="wx-compass-ring">
                                <div class="wx-n">N</div><div class="wx-e">E</div><div class="wx-s">S</div><div class="wx-w">W</div>
                                <div class="wx-arrow" id="windArrow"></div>
                            </div>
                            <div class="wx-sub" id="windSub">‚Äî</div>
                        </div>
                    </div>

                    <!-- 5: Sunset -->
                    <div class="wx-card" data-card="sun">
                        <div class="wx-card-head">
                            <div class="wx-label">Sunset</div>
                            <div class="wx-big" id="sunsetText">‚Äî</div>
                        </div>

                        <div class="wx-sunline">
                            <svg viewBox="0 0 220 90" class="wx-sunsvg">
                                <path class="wx-suntrack" d="M20 70 C70 20 150 20 200 70" />
                                <circle class="wx-sundot" cx="200" cy="70" r="7" />
                                <line class="wx-horizon" x1="20" y1="70" x2="200" y2="70" />
                            </svg>
                            <div class="wx-sub" id="sunSub">‚Äî</div>
                        </div>
                    </div>

                    <!-- 6: Pressure -->
                    <div class="wx-card" data-card="press">
                        <div class="wx-card-head">
                            <div class="wx-label">Pressure</div>
                            <div class="wx-big" id="pressText">‚Äî</div>
                        </div>

                        <div class="wx-gauge">
                            <svg viewBox="0 0 120 80" class="wx-gsvg">
                                <path class="wx-track" d="M10 70 A50 50 0 0 1 110 70" />
                                <path class="wx-prog" d="M10 70 A50 50 0 0 1 110 70" />
                                <circle class="wx-dot" cx="10" cy="70" r="5" />
                            </svg>
                            <div class="wx-sub">mbar</div>
                        </div>
                    </div>
                </div>

                <div class="wx-forecast">
                    <div class="wx-forecast-title">7-day forecast</div>
                    <div class="wx-days" id="wxDays"></div>
                </div>
            </div>
        </div>
    </section>


    <div class="app">


        <!-- ===== –ü–ï–†–°–û–ù–ê–õ–¨–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò ===== -->
        <section class="reco" id="reco" aria-labelledby="recoTitle">
            <div class="reco-head">
                <div>
                    <div class="reco-kicker">Personal for you</div>
                    <h2 class="reco-title" id="recoTitle">Recommended trip</h2>
                    <p class="reco-sub" id="recoSub">Fill in your profile ‚Äî and recommendations will take into account your goals, experience, and past views.</p>
                </div>

                <div class="reco-actions">
                    <a class="reco-link" href="profile_1_v2.html" title="Set up profile">Set up profile</a>
                    <button class="reco-btn" id="recoRefresh" type="button" title="Recalculate recommendations">Refresh</button>
                </div>
            </div>

            <div class="reco-grid" id="recoGrid" aria-live="polite"></div>

            <div class="reco-empty" id="recoEmpty" hidden>
                <p style="margin:0;">No profile data yet. Open ‚ÄúProfile‚Äù, choose a goal, duration, and transport ‚Äî and this section will become personal.</p>
            </div>
        </section>

        <!-- –ò–ù–§–û-–≠–ö–†–ê–ù -->
        <div class="info-panel" id="info">
            <h2>Welcome</h2>
            <p>I‚Äôll show you the best places in East Kazakhstan.</p>
        </div>

        <!-- –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø -->
        <div class="side">
            <select id="filter" onchange="applyFilter()">
                <option value="all">All places</option>
                <option value="mountains">Mountains & ridges</option>
                <option value="lakes">Lakes & reservoirs</option>
                <option value="rivers">Rivers</option>
                <option value="forests">Forests & taiga</option>
                <option value="plateaus">Plateaus</option>
                <option value="canyons">Canyons & gorges</option>
                <option value="steppes">Steppes & meadows</option>
                <option value="glaciers">Glaciers</option>
            </select>

            <div class="buttons" id="buttons"></div>
        </div>
    </div>


    <script src="script_personalized.fixed.v2_EN.js"></script>

    <script>
        /* ===== –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø–æ localStorage.userProfile ===== */
        (function () {
            const PROFILE_KEY = "userProfile";
            const HISTORY_KEY = "userHistory_v1";

            function safeParse(json) {
                try { return JSON.parse(json); } catch { return null; }
            }

            function getProfile() {
                const raw = localStorage.getItem(PROFILE_KEY);
                const p = raw ? safeParse(raw) : null;
                if (!p || typeof p !== "object") return null;
                return {
                    name: typeof p.name === "string" ? p.name.trim() : "",
                    notes: typeof p.notes === "string" ? p.notes.trim() : "",
                    goal: typeof p.goal === "string" ? p.goal : "",
                    level: typeof p.level === "string" ? p.level : "",
                    duration: typeof p.duration === "string" ? p.duration : "",
                    transport: typeof p.transport === "string" ? p.transport : "",
                    interests: Array.isArray(p.interests) ? p.interests.filter(Boolean) : [],
                };
            }

            function getHistory() {
                const raw = localStorage.getItem(HISTORY_KEY);
                const h = raw ? safeParse(raw) : null;
                if (!h || typeof h !== "object") {
                    return { views: {}, byType: {}, last: [] };
                }
                return {
                    views: (h.views && typeof h.views === "object") ? h.views : {},
                    byType: (h.byType && typeof h.byType === "object") ? h.byType : {},
                    last: Array.isArray(h.last) ? h.last : [],
                };
            }

            function setHistory(h) {
                localStorage.setItem(HISTORY_KEY, JSON.stringify(h));
            }

            /* –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ script.js –ø—Ä–∏ –∫–ª–∏–∫–µ –ø–æ –º–µ—Å—Ç—É */
            window.trackPlaceView = function (place) {
                if (!place || !place.name) return;
                const h = getHistory();
                h.views[place.name] = (h.views[place.name] || 0) + 1;
                if (place.type) h.byType[place.type] = (h.byType[place.type] || 0) + 1;
                h.last.unshift({ name: place.name, type: place.type || "", ts: Date.now() });
                h.last = h.last.slice(0, 20);
                setHistory(h);
            };

            const GOAL_TYPES = {
                relax: ["lakes", "forests", "rivers", "steppes"],
                family: ["lakes", "forests", "rivers", "steppes"],
                trekking: ["mountains", "plateaus", "canyons", "glaciers"],
                photo: ["mountains", "plateaus", "canyons", "glaciers", "lakes"],
                fishing: ["lakes", "rivers"],
            };

            /* –ü–æ–¥–ø–∏—Å–∏ */
            const LABELS = {
                goal: { relax: "Relax", family: "Family", trekking: "Trekking", photo: "Photo", fishing: "Fishing" },
                level: { beginner: "Beginner", medium: "Medium", advanced: "Advanced" },
                duration: { "1day": "1 day", weekend: "Weekend", "3to5": "3‚Äì5 days" },
                transport: { car: "Car", public: "Public", tour: "Tour" },
                interests: {
                    lakes: "Lakes",
                    mountains: "Mountains",
                    waterfalls: "Waterfalls",
                    canyons: "Canyons",
                    forests: "Forests/taiga",
                    rivers: "Rivers",
                    plateaus: "Plateaus",
                    steppes: "Steppes/meadows",
                    glaciers: "Glaciers",
                }
            };

            function label(group, key) {
                return (LABELS[group] && LABELS[group][key]) ? LABELS[group][key] : String(key);
            }

            /* –ú–∏–Ω–∏-–º–µ—Ç–∞ –ø–æ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏ (–º–æ–∂–µ—à—å —Ä–∞—Å—à–∏—Ä—è—Ç—å) */
            const PLACE_META = {
                "–ê–ª—Ç–∞–π (–ö–∞—Ç–æ–Ω-–ö–∞—Ä–∞–≥–∞–π)": { minDays: 3, access: ["car", "tour"] },
                "–í–æ—Å—Ç–æ—á–Ω—ã–π –ê–ª—Ç–∞–π": { minDays: 3, access: ["car", "tour"] },
                "–ö–∞—Ç–æ–Ω-–ö–∞—Ä–∞–≥–∞–π—Å–∫–æ–µ –ø–ª–∞—Ç–æ": { minDays: 2, access: ["car", "tour"] },
                "–ú–∞—Ä–∫–∞–∫–æ–ª—å": { minDays: 3, access: ["car", "tour"] },
                "Glaciers –í–æ—Å—Ç–æ—á–Ω–æ–≥–æ –ê–ª—Ç–∞—è": { minDays: 3, access: ["tour", "car"] },
                "–õ–µ–¥–Ω–∏–∫ –ë–µ–ª—É—Ö–∞": { minDays: 4, access: ["tour", "car"] },
                "–û–∑–µ—Ä–æ –ó–∞–π—Å–∞–Ω": { minDays: 2, access: ["car", "tour"] },
                "–ë—É—Ö—Ç–∞—Ä–º–∏–Ω—Å–∫–æ–µ –≤–æ–¥–æ—Ö—Ä–∞–Ω–∏–ª–∏—â–µ": { minDays: 1, access: ["car", "public", "tour"] },
                "–õ–µ–Ω—Ç–æ—á–Ω—ã–µ –±–æ—Ä—ã –ü—Ä–∏–∏—Ä—Ç—ã—à—å—è": { minDays: 1, access: ["car", "public"] },
                "–ò—Ä—Ç—ã—à": { minDays: 1, access: ["car", "public"] },
                "–£–ª—å–±–∏–Ω—Å–∫–æ–µ –ø–ª–∞—Ç–æ": { minDays: 1, access: ["car", "tour"] },
            };

            function durationMaxDays(duration) {
                if (duration === "1day") return 1;
                if (duration === "weekend") return 2;
                if (duration === "3to5") return 5;
                return 2;
            }

            function defaultMeta(place) {
                const type = place.type;
                const minDays = (type === "glaciers") ? 3
                    : (type === "mountains" || type === "plateaus" || type === "canyons") ? 2
                        : 1;

                const access = (type === "lakes" || type === "forests" || type === "rivers" || type === "steppes")
                    ? ["car", "public", "tour"]
                    : ["car", "tour"];

                return { minDays, access };
            }

            function extractPreview(placeContent) {
                try {
                    const doc = new DOMParser().parseFromString(placeContent, "text/html");
                    const img = doc.querySelector("img.place-photo")?.getAttribute("src") || "";
                    const text = (doc.querySelector(".place-text")?.textContent || "").trim();
                    return { img, text };
                } catch {
                    return { img: "", text: "" };
                }
            }

            function topTypeFromHistory(history) {
                let best = "";
                let bestN = 0;
                for (const [t, n] of Object.entries(history.byType || {})) {
                    if (n > bestN) { bestN = n; best = t; }
                }
                return best;
            }

            /* ===== ‚Äú–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–π‚Äù —Å–∫–æ—Ä–∏–Ω–≥ (–ø—Ä–æ—Ñ–∏–ª—å + –∏—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π) ===== */
            function scorePlace(place, profile, history) {
                let score = 0;
                const type = place.type;

                const meta = PLACE_META[place.name] || defaultMeta(place);
                const maxDays = durationMaxDays(profile.duration);

                /* 1) –ò–Ω—Ç–µ—Ä–µ—Å—ã ‚Äî —Å–∞–º—ã–π —Å–∏–ª—å–Ω—ã–π —Å–∏–≥–Ω–∞–ª */
                if (profile.interests.includes(type)) score += 40;

                /* 2) –¶–µ–ª—å */
                const goalTypes = GOAL_TYPES[profile.goal] || [];
                if (goalTypes.includes(type)) score += 20;

                /* 3) –£—Ä–æ–≤–µ–Ω—å */
                if (profile.level === "beginner") {
                    if (type === "glaciers") score -= 35;
                    else if (type === "mountains" || type === "canyons" || type === "plateaus") score -= 10;
                    else score += 6;
                } else if (profile.level === "advanced") {
                    if (type === "glaciers" || type === "mountains" || type === "canyons" || type === "plateaus") score += 10;
                }

                /* 4) –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å */
                if (meta.minDays <= maxDays) score += 12;
                else score -= 22;

                /* 5) –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç */
                if (profile.transport) {
                    if (meta.access.includes(profile.transport)) score += 10;
                    else score -= 25;
                }

                /* 6) –ü—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è: –Ω–µ –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–µ */
                const views = (history.views && history.views[place.name]) ? history.views[place.name] : 0;
                if (views > 0) score -= 15;

                /* 7) –ü–æ—Ö–æ–∂–µ–µ –Ω–∞ —Ç–æ, —á—Ç–æ —Å–º–æ—Ç—Ä–µ–ª–∏ */
                const histTopType = topTypeFromHistory(history);
                if (histTopType && histTopType === type && views === 0) score += 8;

                /* 8) –ú–∏–Ω–∏-–±–æ–Ω—É—Å –∑–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ—Ñ–∏–ª—è */
                const filled = [profile.goal, profile.level, profile.duration, profile.transport].filter(Boolean).length;
                score += filled * 1.5;

                return score;
            }

            function buildReason(place, profile, history) {
                const reasons = [];
                if (profile.interests.includes(place.type)) reasons.push("matches your interests");
                if ((GOAL_TYPES[profile.goal] || []).includes(place.type)) reasons.push("fits your goal");
                const meta = PLACE_META[place.name] || defaultMeta(place);

                if (profile.duration) {
                    const maxDays = durationMaxDays(profile.duration);
                    if (meta.minDays <= maxDays) reasons.push("fits your time");
                }

                if (profile.transport && meta.access.includes(profile.transport)) reasons.push("reachable with your transport");

                const histTopType = topTypeFromHistory(history);
                if (histTopType && histTopType === place.type) reasons.push("similar to what you viewed before");

                if (reasons.length === 0) reasons.push("may suit you based on your profile");
                return reasons.slice(0, 3).join(" ‚Ä¢ ");
            }

            function chip(text) {
                const span = document.createElement("span");
                span.className = "reco-chip";
                span.textContent = text;
                return span;
            }

            function renderRecommendations() {
                const grid = document.getElementById("recoGrid");
                const empty = document.getElementById("recoEmpty");
                const sub = document.getElementById("recoSub");
                if (!grid || !empty || !sub) return;

                const profile = getProfile();
                const history = getHistory();

                const hasProfile = !!(profile && (profile.goal || profile.duration || profile.transport || (profile.interests && profile.interests.length)));
                if (!hasProfile) {
                    grid.innerHTML = "";
                    empty.hidden = false;
                    sub.textContent = "Fill in your profile ‚Äî and recommendations will take into account your goals, experience, and past views.";
                    return;
                }

                empty.hidden = true;

                const username = profile.name ? `, ${profile.name}` : "";
                const interestsTxt = (profile.interests || []).length
                    ? `Interests: ${(profile.interests || []).map(t => label("interests", t)).join(", ")}`
                    : "";
                sub.textContent = `We use your profile${username}. ${interestsTxt}`.trim();

                const list = (typeof places !== "undefined" && Array.isArray(places)) ? places.slice() : [];
                const ranked = list
                    .map(p => ({ p, s: scorePlace(p, profile, history) }))
                    .sort((a, b) => b.s - a.s)
                    .slice(0, 4)
                    .map(x => x.p);

                grid.innerHTML = "";

                ranked.forEach(p => {
                    const { img, text } = extractPreview(p.content);

                    const card = document.createElement("article");
                    card.className = "reco-card";

                    const media = document.createElement("div");
                    media.className = "reco-media";
                    if (img) media.style.backgroundImage = `url('${img}')`;

                    const body = document.createElement("div");
                    body.className = "reco-body";

                    const title = document.createElement("h3");
                    title.className = "reco-card-title";
                    title.textContent = p.name;

                    const chips = document.createElement("div");
                    chips.className = "reco-chips";
                    if (profile.goal) chips.appendChild(chip(`goal: ${label("goal", profile.goal)}`));
                    if (profile.duration) chips.appendChild(chip(`time: ${label("duration", profile.duration)}`));
                    if (profile.transport) chips.appendChild(chip(`transport: ${label("transport", profile.transport)}`));
                    if (profile.interests.includes(p.type)) chips.appendChild(chip(`interest: ${label("interests", p.type)}`));

                    const reason = document.createElement("p");
                    reason.className = "reco-reason";
                    reason.textContent = buildReason(p, profile, history);

                    const teaser = document.createElement("p");
                    teaser.className = "reco-teaser";
                    teaser.textContent = text ? (text.length > 160 ? text.slice(0, 160) + "‚Ä¶" : text) : "";

                    const actions = document.createElement("div");
                    actions.className = "reco-card-actions";

                    const openBtn = document.createElement("button");
                    openBtn.type = "button";
                    openBtn.className = "reco-btn";
                    openBtn.textContent = "Open description";
                    openBtn.addEventListener("click", () => {
                        const info = document.getElementById("info");
                        if (info) {
                            info.innerHTML = p.content;
                            window.trackPlaceView?.(p);
                            info.scrollIntoView({ behavior: "smooth", block: "start" });
                        }
                    });

                    const toFilter = document.createElement("button");
                    toFilter.type = "button";
                    toFilter.className = "reco-btn ghost";
                    toFilter.textContent = "Show similar";
                    toFilter.addEventListener("click", () => {
                        const sel = document.getElementById("filter");
                        if (sel) {
                            sel.value = p.type;
                            if (typeof applyFilter === "function") applyFilter();
                            document.getElementById("buttons")?.scrollIntoView({ behavior: "smooth", block: "start" });
                        }
                    });

                    actions.appendChild(openBtn);
                    actions.appendChild(toFilter);

                    body.appendChild(title);
                    body.appendChild(chips);
                    body.appendChild(reason);
                    if (teaser.textContent) body.appendChild(teaser);
                    body.appendChild(actions);

                    card.appendChild(media);
                    card.appendChild(body);
                    grid.appendChild(card);
                });
            }

            window.refreshRecommendations = renderRecommendations;

            const btn = document.getElementById("recoRefresh");
            if (btn) btn.addEventListener("click", renderRecommendations);

            renderRecommendations();
        })();
    </script>


    <!-- ===== –°–ï–ö–¶–ò–Ø –ö–ê–†–¢–´ (–ü–ï–†–ï–î –§–£–¢–ï–†–û–ú) ===== -->
    <section class="route-section" id="map12345">
        <div class="route-wrapper">

            <div class="panel">
                <h2>Route builder (up to 6 points)</h2>

                <label class="route-label" for="pointStart">Start</label>
                <select id="pointStart">
                    <option value="">Choose a start</option>
                </select>

                <label class="route-label" for="pointEnd">Finish</label>
                <select id="pointEnd">
                    <option value="">Choose a finish</option>
                </select>

                <div class="route-stops">
                    <label class="route-label" for="pointAdd">Stopover</label>
                    <div class="route-stops-row">
                        <select id="pointAdd">
                            <option value="">Add a stop‚Ä¶</option>
                        </select>
                        <button id="stopAddBtn" type="button" class="swap">Add</button>
                    </div>

                    <ul class="stops-list" id="stopsList"></ul>
                    <p class="route-hint">Tip: add 1‚Äì4 stops between start and finish (maximum 6 points total).</p>
                </div>

                <button id="routeBuild" type="button">Build route</button>
                <div class="route-actions">
                    <button id="routeSwap" type="button" class="swap">Reverse route</button>
                    <button id="routeClear" type="button" class="swap danger">Clear</button>
                </div>

                <div class="route-info" id="routeInfo"></div>
            </div>

            <div id="map"></div>

        </div>
    </section>

    <section class="guides" id="guides">
        <div class="container">
            <div class="guides-head">
                <h2 class="guides-title">Our guides</h2>
                <p class="guides-subtitle">
                    Choose a guide that matches your travel style: mountains, lakes, trekking, or comfortable tours.
                </p>

                <!-- –î–æ–±–∞–≤–ª–µ–Ω–æ: —Å—Ç—Ä–æ–∫–∞ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π -->
                <p class="guides-reco" id="guidesReco" hidden></p>
            </div>

            <div class="guides-grid">
                <article class="guide-card" data-guide="g1">
                    <img class="guide-img" src="" alt="Guide Kirill">
                    <div class="guide-overlay">
                        <h3 class="guide-name">–ö–∏—Ä–∏–ª–ª</h3>
                        <p class="guide-role">Mountain routes ‚Ä¢ Altai</p>
                        <p class="guide-meta">Experience: 5 years ‚Ä¢ RU/EN</p>
                    </div>
                </article>

                <article class="guide-card" data-guide="g2">
                    <img class="guide-img" src="" alt="Guide Amir">
                    <div class="guide-overlay">
                        <h3 class="guide-name">–ê–º–∏—Ä</h3>
                        <p class="guide-role">Lakes ‚Ä¢ Markakol</p>
                        <p class="guide-meta">Experience: 4 years ‚Ä¢ RU/KZ</p>
                    </div>
                </article>

                <article class="guide-card" data-guide="g3">
                    <img class="guide-img" src="" alt="Guide Aruzhan">
                    <div class="guide-overlay">
                        <h3 class="guide-name">–ê—Ä—É–∂–∞–Ω</h3>
                        <p class="guide-role">Family tours ‚Ä¢ Locations</p>
                        <p class="guide-meta">Experience: 3 years ‚Ä¢ RU/EN</p>
                    </div>
                </article>

                <article class="guide-card" data-guide="g4">
                    <img class="guide-img" src="" alt="Guide Zhanarys">
                    <div class="guide-overlay">
                        <h3 class="guide-name">–ñ–∞–Ω–∞—Ä—ã—Å</h3>
                        <p class="guide-role">Trekking ‚Ä¢ Plateaus/passes</p>
                        <p class="guide-meta">Experience: 6 years ‚Ä¢ RU/KZ</p>
                    </div>
                </article>

                <article class="guide-card" data-guide="g5">
                    <img class="guide-img" src="" alt="Guide Aliya">
                    <div class="guide-overlay">
                        <h3 class="guide-name">–ê–ª–∏—è</h3>
                        <p class="guide-role">Photo tours ‚Ä¢ Best views</p>
                        <p class="guide-meta">Experience: 4 years ‚Ä¢ RU/EN</p>
                    </div>
                </article>

            </div>
        </div>
    </section>


    <section class="apply-cta-screen">
        <a class="apply-btn" href="HTMLPage1.html" target="_blank" rel="noopener">Submit a request</a>
    </section>

    <section class="trip" id="trip">
        <div class="container">
            <h2>My trip plan</h2>
            <p class="trip-sub">Save places, change the order, and add notes. Data is stored in localStorage.</p>

            <div class="trip-grid">
                <div class="trip-card">
                    <div class="trip-head">
                        <h3>Favorites</h3>
                        <button class="trip-btn" type="button" id="tripShareLink">Copy link</button>


                        <button class="trip-btn ghost" type="button" id="tripClearFav">Clear</button>
                    </div>
                    <div id="favList" class="trip-list"></div>
                </div>

                <div class="trip-card">
                    <div class="trip-head">
                        <h3>Route / Plan</h3>
                        <button class="trip-btn ghost" type="button" id="tripClearPlan">Clear</button>
                    </div>
                    <div id="planList" class="trip-list"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- ===== FOOTER ===== -->
    <!-- ===================== COMMENTS / REVIEWS ===================== -->
    <section id="comments" class="comments-section">
        <div class="container">
            <h2 class="section-title">Reviews</h2>
            <p class="comments-subtitle">Leave a comment ‚Äî it helps us improve the service and routes.</p>

            <div class="comments-grid">
                <form id="commentForm" class="comment-form">
                    <div class="comment-row">
                        <label class="comment-field">
                            <span class="comment-label">Name</span>
                            <input id="commentName" type="text" maxlength="40" placeholder="For example: Aliya" required>
                        </label>

                        <label class="comment-field">
                            <span class="comment-label">Rating</span>
                            <select id="commentRating" required>
                                <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ (5)</option>
                                <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ (4)</option>
                                <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ (3)</option>
                                <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ (2)</option>
                                <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ (1)</option>
                            </select>
                        </label>
                    </div>

                    <label class="comment-field comment-field-full">
                        <span class="comment-label">Comment</span>
                        <textarea id="commentText" rows="4" maxlength="400" placeholder="What did you like? What can be improved?" required></textarea>
                        <span class="comment-hint"><span id="commentCount">0</span>/400</span>
                    </label>

                    <div class="comment-actions">
                        <button type="submit" class="btn btn-primary">Send</button>
                        <button type="button" class="btn btn-secondary" id="clearReviews">Clear</button>
                    </div>

         
                </form>

                <div class="comment-list-card">
                    <div class="comment-list-head">
                        <h3 class="comment-list-title">Latest reviews</h3>
                        <span class="comment-badge" id="commentsTotal">0</span>
                    </div>
                    <div id="commentsList" class="comment-list" aria-live="polite"></div>
                </div>
            </div>
        </div>
    </section>





    <footer class="footer">
        <div class="footer-container container">

            <div class="footer-about">
                <h4>East Kazakhstan Guide</h4>
                <p>Travel in East Kazakhstan</p>
            </div>

            <div class="footer-nav">
                <h4>Navigation</h4>
                <ul>
                    <li><a href="#">Routes</a></li>
                    <li><a href="#">About</a></li>
                    <li><a href="#">Gallery</a></li>
                    <li><a href="#">Contacts</a></li>
                </ul>
            </div>

            <div class="footer-contacts">
                <h4>Contacts</h4>
                <p>Email: info@vko-travel.kz</p>
                <p>Phone: +7 (777) 000-00-00</p>
            </div>

        </div>
        <div class="footer-bottom">¬© 2026 ‚Ä¢ Travel in East Kazakhstan</div>
    </footer>

    <!-- ===== SCRIPTS ===== -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>


    <script>
        (() => {
            const PROFILE_KEY = "userProfile";
            const LEVEL_RANK = { beginner: 1, medium: 2, advanced: 3 };


            const GUIDE_RULES = {
                g1: { displayName: "–ö–∏—Ä–∏–ª–ª", goals: ["trekking", "photo"], interests: ["mountains", "plateaus", "glaciers"], transport: ["car", "tour"], minLevel: "medium" },
                g2: { displayName: "–ê–º–∏—Ä", goals: ["relax", "fishing", "family"], interests: ["lakes", "rivers"], transport: ["car", "tour", "public"], minLevel: "beginner" },
                g3: { displayName: "–ê—Ä—É–∂–∞–Ω", goals: ["family", "relax"], interests: ["lakes", "forests", "steppes", "rivers"], transport: ["car", "tour", "public"], minLevel: "beginner" },
                g4: { displayName: "–ñ–∞–Ω–∞—Ä—ã—Å", goals: ["trekking"], interests: ["mountains", "plateaus", "canyons", "glaciers"], transport: ["car", "tour"], minLevel: "medium" },
                g5: { displayName: "–ê–ª–∏—è", goals: ["photo"], interests: ["mountains", "lakes", "plateaus", "canyons"], transport: ["car", "tour", "public"], minLevel: "beginner" },
            };

            // –ï—Å–ª–∏ –ø—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ-—Ä—É—Å—Å–∫–∏ ‚Äî –ø—Ä–∏–≤–æ–¥–∏–º –∫ –Ω–∞—à–∏–º –∫–ª—é—á–∞–º.
            const MAP_GOAL = {
                "—Ç—Ä–µ–∫–∫–∏–Ω–≥": "trekking", "trekking": "trekking",
                "—Ñ–æ—Ç–æ": "photo", "—Ñ–æ—Ç–æ-—Ç—É—Ä—ã": "photo", "photo": "photo",
                "—Å–µ–º–µ–π–Ω—ã–µ": "family", "—Å–µ–º–µ–π–Ω—ã–π": "family", "family": "family",
                "–æ—Ç–¥—ã—Ö": "relax", "relax": "relax",
                "—Ä—ã–±–∞–ª–∫–∞": "fishing", "fishing": "fishing",
            };

            const MAP_TRANSPORT = {
                "–º–∞—à–∏–Ω–∞": "car", "–∞–≤—Ç–æ": "car", "car": "car",
                "—Ç—É—Ä": "tour", "tour": "tour",
                "–æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω—ã–π": "public", "public": "public",
            };

            const MAP_INTEREST = {
                "–≥–æ—Ä—ã": "mountains", "mountains": "mountains",
                "–æ–∑—ë—Ä–∞": "lakes", "–æ–∑–µ—Ä–∞": "lakes", "lakes": "lakes",
                "–ª–µ—Å–∞": "forests", "forests": "forests",
                "—Å—Ç–µ–ø–∏": "steppes", "steppes": "steppes",
                "—Ä–µ–∫–∏": "rivers", "rivers": "rivers",
                "–ø–ª–∞—Ç–æ": "plateaus", "plateaus": "plateaus",
                "–∫–∞–Ω—å–æ–Ω—ã": "canyons", "canyons": "canyons",
                "–ª–µ–¥–Ω–∏–∫–∏": "glaciers", "glaciers": "glaciers",
            };

            const safeParse = (s) => { try { return JSON.parse(s); } catch { return null; } };
            const norm = (v) => (typeof v === "string" ? v.trim().toLowerCase() : "");

            const normalizeProfile = (p) => {
                const goal = MAP_GOAL[norm(p.goal)] || (p.goal || "");
                const transport = MAP_TRANSPORT[norm(p.transport)] || (p.transport || "");
                const level = norm(p.level); // –æ–∂–∏–¥–∞–µ–º beginner/medium/advanced

                const interestsRaw = Array.isArray(p.interests) ? p.interests : [];
                const interests = interestsRaw
                    .map(x => MAP_INTEREST[norm(x)] || "")
                    .filter(Boolean);

                return { goal, transport, level, interests };
            };

            const getProfile = () => {
                const raw = localStorage.getItem(PROFILE_KEY);
                const p = raw ? safeParse(raw) : null;
                if (!p || typeof p !== "object") return null;

                return normalizeProfile({
                    goal: typeof p.goal === "string" ? p.goal : "",
                    level: typeof p.level === "string" ? p.level : "",
                    transport: typeof p.transport === "string" ? p.transport : "",
                    interests: Array.isArray(p.interests) ? p.interests : [],
                });
            };

            const levelRank = (l) => LEVEL_RANK[l] || 0;

            function scoreGuide(rule, profile) {
                // –ñ–Å–°–¢–ö–ò–ï —Ñ–∏–ª—å—Ç—Ä—ã:
                if (profile.transport && !rule.transport?.includes(profile.transport)) return null;

                const pr = levelRank(profile.level);
                const mr = levelRank(rule.minLevel);
                if (pr && mr && pr < mr) return null;

                // –°–∫–æ—Ä–∏–Ω–≥:
                const goalMatch = profile.goal && rule.goals?.includes(profile.goal);
                const interestMatches = (profile.interests || []).filter(t => rule.interests?.includes(t));
                const m = interestMatches.length;

                // –ï—Å–ª–∏ –≤–æ–æ–±—â–µ –Ω–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π (–Ω–∏ —Ü–µ–ª—å, –Ω–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã) ‚Äî –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º
                if (!goalMatch && m === 0) return null;

                let s = 0;
                if (goalMatch) s += 45;
                if (!goalMatch && profile.goal) s -= 15; // –µ—Å—Ç—å —Ü–µ–ª—å, –Ω–æ –Ω–µ —Å–æ–≤–ø–∞–ª–æ

                s += m * 18;            // –∏–Ω—Ç–µ—Ä–µ—Å—ã –≤–∞–∂–Ω–µ–µ
                if (m >= 2) s += 12;
                if (m >= 3) s += 8;

                return { score: s, goalMatch, interestMatches };
            }

            function clearRecommendation(cards) {
                for (const c of cards) {
                    c.classList.remove("recommended");
                    c.querySelector(".guide-badge")?.remove();
                }
            }

            function applyGuideRecommendation() {
                const grid = document.querySelector(".guides-grid");
                if (!grid) return;

                const cards = Array.from(grid.querySelectorAll(".guide-card[data-guide]"));
                if (!cards.length) return;

                const profile = getProfile();
                const hasProfile =
                    !!profile &&
                    (!!profile.goal || !!profile.level || !!profile.transport || (profile.interests?.length > 0));
                if (!hasProfile) return;

                const scored = cards
                    .map(card => {
                        const id = (card.getAttribute("data-guide") || "").trim();
                        const rule = GUIDE_RULES[id];
                        if (!rule) return null;

                        const r = scoreGuide(rule, profile);
                        if (!r) return null;

                        return { card, rule, ...r };
                    })
                    .filter(Boolean)
                    .sort((a, b) => (b.score || 0) - (a.score || 0));

                const best = scored[0];
                if (!best) return;

                // –ø–æ—Ä–æ–≥ ‚Äî —á—Ç–æ–±—ã –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞—Ç—å –ø—Ä–∏ —Å–ª–∞–±–æ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–∏
                if (best.score < 35) return;

                clearRecommendation(cards);

                best.card.classList.add("recommended");
                const badge = document.createElement("span");
                badge.className = "guide-badge";
                badge.textContent = "Recommended";
                best.card.appendChild(badge);

                const reco = document.getElementById("guidesReco");
                if (reco) {
                    reco.hidden = false;
                    reco.textContent = "Recommended guide: " + best.rule.displayName;
                }

                // –ø–æ–¥–Ω–∏–º–∞–µ–º –ø–µ—Ä–≤—ã–º
                grid.prepend(best.card);
            }

            document.addEventListener("DOMContentLoaded", applyGuideRecommendation, { once: true });
        })();
    </script>


    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const slider = document.querySelector(".events-slider");
            if (!slider) return;

            const track = slider.querySelector(".events-track");
            const windowEl = slider.querySelector(".events-window");
            const btnLeft = slider.querySelector(".arrow.left");
            const btnRight = slider.querySelector(".arrow.right");

            let step = 0;
            let gap = 0;
            let visible = 3;
            let auto = null;
            let isAnimating = false;
            let dir = "next"; // "next" | "prev"

            function ensureEnoughCards() {
                const base = Array.from(track.children);
                if (base.length === 0) return;

                // –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º visible+2, —á—Ç–æ–±—ã –∫–∞—Ä—É—Å–µ–ª—å –Ω–µ ‚Äú–∫–æ–Ω—á–∞–ª–∞—Å—å‚Äù
                while (track.children.length < visible + 2) {
                    for (const c of base) {
                        if (track.children.length >= visible + 2) break;
                        track.appendChild(c.cloneNode(true));
                    }
                }
            }

            function recalc() {
                const card = track.querySelector(".card");
                if (!card) return;

                gap = parseFloat(getComputedStyle(track).gap) || 0;

                // —à–∏—Ä–∏–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ (–ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –æ–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ)
                const cardW = card.getBoundingClientRect().width;
                step = cardW + gap;

                const winW = windowEl.getBoundingClientRect().width;
                visible = Math.max(1, Math.floor((winW + gap) / step));

                ensureEnoughCards();

                // –°–±—Ä–æ—Å –ø–æ–∑–∏—Ü–∏–∏ –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏ (–≤–∞–∂–Ω–æ –ø—Ä–∏ resize)
                track.style.transition = "none";
                track.style.transform = "translateX(0px)";
                track.getBoundingClientRect(); // reflow
                track.style.transition = "transform .45s ease";
            }

            function stop() {
                if (auto) clearInterval(auto);
                auto = null;
            }

            function start() {
                stop();
                auto = setInterval(() => next(), 3000);
            }

            function next() {
                if (isAnimating || !step) return;
                dir = "next";
                isAnimating = true;
                track.style.transform = `translateX(-${step}px)`;
            }

            function prev() {
                if (isAnimating || !step) return;
                dir = "prev";
                isAnimating = true;

                // 1) –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–æ—Å–∏–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–∞—Ä—Ç–æ—á–∫—É –≤ –Ω–∞—á–∞–ª–æ
                const last = track.lastElementChild;
                track.style.transition = "none";
                track.insertBefore(last, track.firstElementChild);

                // 2) —Å—Ç–∞–≤–∏–º –ª–µ–Ω—Ç—É –≤ –ø–æ–∑–∏—Ü–∏—é -step –±–µ–∑ –∞–Ω–∏–º–∞—Ü–∏–∏
                track.style.transform = `translateX(-${step}px)`;
                track.getBoundingClientRect(); // reflow

                // 3) –∞–Ω–∏–º–∏—Ä—É–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ 0
                track.style.transition = "transform .45s ease";
                track.style.transform = "translateX(0px)";
            }

            track.addEventListener("transitionend", (e) => {
                if (e.propertyName !== "transform") return;

                // –ü–æ—Å–ª–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤–ø—Ä–∞–≤–æ/–≤–ª–µ–≤–æ –¥–µ–ª–∞–µ–º ‚Äú–∫–∞—Ä—É—Å–µ–ª—å‚Äù —á–µ—Ä–µ–∑ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫—É DOM
                if (dir === "next") {
                    track.style.transition = "none";
                    track.appendChild(track.firstElementChild);
                    track.style.transform = "translateX(0px)";
                    track.getBoundingClientRect(); // reflow
                    track.style.transition = "transform .45s ease";
                }

                isAnimating = false;
            });

            btnRight?.addEventListener("click", () => {
                stop();
                next();
                start();
            });

            btnLeft?.addEventListener("click", () => {
                stop();
                prev();
                start();
            });

            windowEl?.addEventListener("mouseenter", stop);
            windowEl?.addEventListener("mouseleave", start);

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ + –ø—Ä–∏ —Ä–µ—Å–∞–π–∑–µ
            window.addEventListener("load", () => {
                recalc();
                start();
            });
            window.addEventListener("resize", recalc);
        });
    </script>


    <script>

        const routePoints = {
            "–£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫": [49.958791, 82.615825],
            "–†–∞—Ö–º–∞–Ω–æ–≤—Å–∫–∏–µ –∫–ª—é—á–∏": [49.53369, 86.50963],
            "–°–µ–º–µ–π": [50.41, 80.23],
            "–†–∏–¥–¥–µ—Ä": [50.33, 83.50],
            "–ö–∞—Ç–æ–Ω": [49.17, 85.59],
            "–ó–∞–π—Å–∞–Ω": [47.97, 84.117],
            "–ú–∞—Ä–∫–∞–∫–æ–ª—å": [48.74, 85.74],
            "–ë—É—Ö—Ç–∞—Ä–º–∏–Ω—Å–∫–æ–µ –≤–æ–¥–æ—Ö—Ä–∞–Ω–∏–ª–∏—â–µ": [49.63083, 83.51811],
            "–õ–µ–¥–Ω–∏–∫ –ë–µ–ª—É—Ö–∞": [49.8070585, 86.5899105],
            "–ê–ª—Ç–∞–π (–ó—ã—Ä—è–Ω–æ–≤—Å–∫)": [49.72246, 84.28093],
            "–°–µ—Ä–µ–±—Ä—è–Ω—Å–∫": [49.6819, 83.2847],
            "–®–µ–º–æ–Ω–∞–∏—Ö–∞": [50.6297, 81.9065],
            "–ì–ª—É–±–æ–∫–æ–µ": [50.1450, 82.3110]
        };

        const MAX_POINTS = 6; // –≤—Å–µ–≥–æ —Ç–æ—á–µ–∫ –≤ –º–∞—Ä—à—Ä—É—Ç–µ: —Å—Ç–∞—Ä—Ç + –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ + —Ñ–∏–Ω–∏—à

        const selectStart = document.getElementById("pointStart");
        const selectEnd = document.getElementById("pointEnd");
        const selectAdd = document.getElementById("pointAdd");
        const listEl = document.getElementById("stopsList");
        const infoBox = document.getElementById("routeInfo");

        const btnBuild = document.getElementById("routeBuild");
        const btnSwap = document.getElementById("routeSwap");
        const btnClear = document.getElementById("routeClear");
        const btnAddStop = document.getElementById("stopAddBtn");

        const pointNames = Object.keys(routePoints);
        pointNames.forEach(p => {
            selectStart.add(new Option(p, p));
            selectEnd.add(new Option(p, p));
            selectAdd.add(new Option(p, p));
        });

        const map = L.map("map").setView([49.97, 82.63], 7);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 18
        }).addTo(map);

        const router = L.Routing.control({
            waypoints: [],
            addWaypoints: false,
            draggableWaypoints: false,
            fitSelectedRoutes: true,
            show: false,
            lineOptions: {
                styles: [{ color: "#2f7f6f", weight: 6, opacity: 0.9 }]
            }
        }).addTo(map);

        router.on("routesfound", function (e) {
            const route = e.routes[0];
            const km = (route.summary.totalDistance / 1000).toFixed(1);
            const min = Math.round(route.summary.totalTime / 60);

            infoBox.style.display = "block";
            infoBox.innerHTML = `
                                Distance: <b>${km} km</b><br>
                                Travel time: <b>${min} min</b>
                            `;
        });

        // ===== multi-stop –ª–æ–≥–∏–∫–∞ =====
        const stops = []; // –º–∞—Å—Å–∏–≤ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö —Ç–æ—á–µ–∫

        function currentRouteKeys() {
            const start = selectStart.value;
            const end = selectEnd.value;
            const keys = [];
            if (start) keys.push(start);
            stops.forEach(s => keys.push(s));
            if (end) keys.push(end);
            return keys;
        }

        function totalPointsCountIfAdded(candidate) {
            const base = currentRouteKeys();
            if (candidate) base.splice(1 + stops.length, 0, candidate);
            // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ
            return base.filter(Boolean).length;
        }

        function renderStops() {
            if (!listEl) return;
            listEl.innerHTML = "";

            if (stops.length === 0) {
                const li = document.createElement("li");
                li.className = "stop-item empty";
                li.textContent = "No stops yet";
                listEl.appendChild(li);
                return;
            }

            stops.forEach((name, idx) => {
                const li = document.createElement("li");
                li.className = "stop-item";

                const title = document.createElement("span");
                title.className = "stop-name";
                title.textContent = `${idx + 1}. ${name}`;

                const actions = document.createElement("div");
                actions.className = "stop-actions";

                const up = document.createElement("button");
                up.type = "button";
                up.className = "mini-btn";
                up.textContent = "‚Üë";
                up.disabled = idx === 0;
                up.addEventListener("click", () => moveStop(idx, -1));

                const down = document.createElement("button");
                down.type = "button";
                down.className = "mini-btn";
                down.textContent = "‚Üì";
                down.disabled = idx === stops.length - 1;
                down.addEventListener("click", () => moveStop(idx, 1));

                const del = document.createElement("button");
                del.type = "button";
                del.className = "mini-btn danger";
                del.textContent = "‚úï";
                del.addEventListener("click", () => removeStop(idx));

                actions.appendChild(up);
                actions.appendChild(down);
                actions.appendChild(del);

                li.appendChild(title);
                li.appendChild(actions);
                listEl.appendChild(li);
            });
        }

        function moveStop(index, dir) {
            const ni = index + dir;
            if (ni < 0 || ni >= stops.length) return;
            const tmp = stops[index];
            stops[index] = stops[ni];
            stops[ni] = tmp;
            renderStops();
            // –µ—Å–ª–∏ –º–∞—Ä—à—Ä—É—Ç —É–∂–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω ‚Äî –æ–±–Ω–æ–≤–∏–º –ª–∏–Ω–∏—é
            if (selectStart.value && selectEnd.value && router.getWaypoints().length) buildRoute();
        }

        function removeStop(index) {
            stops.splice(index, 1);
            renderStops();
            if (selectStart.value && selectEnd.value && router.getWaypoints().length) buildRoute();
        }

        function addStop() {
            const candidate = selectAdd.value;
            if (!candidate) return;

            const start = selectStart.value;
            const end = selectEnd.value;

            // –Ω–µ–ª—å–∑—è –¥–æ–±–∞–≤–ª—è—Ç—å —Å—Ç–∞—Ä—Ç/—Ñ–∏–Ω–∏—à –∫–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫—É
            if (candidate === start || candidate === end) {
                alert("This point is already selected as start/finish.");
                return;
            }

            // –±–µ–∑ –¥—É–±–ª–µ–π
            if (stops.includes(candidate)) {
                alert("This stop has already been added.");
                return;
            }

            const total = (start ? 1 : 0) + (end ? 1 : 0) + (stops.length + 1);
            if (total > MAX_POINTS) {
                alert(`Maximum ${MAX_POINTS} points in the route. Remove an extra stop.`);
                return;
            }

            stops.push(candidate);
            selectAdd.value = "";
            renderStops();
        }

        function buildRoute() {
            const start = selectStart.value;
            const end = selectEnd.value;

            if (!start || !end) {
                alert("Choose a start and finish.");
                return;
            }

            const keys = [start, ...stops, end];

            // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–µ–π –≤ —Ü–µ–ª–æ–º
            const uniq = new Set(keys);
            if (uniq.size !== keys.length) {
                alert("The route contains duplicate points. Remove duplicates.");
                return;
            }

            if (keys.length < 2) {
                alert("You need at least 2 points.");
                return;
            }

            if (keys.length > MAX_POINTS) {
                alert(`Maximum ${MAX_POINTS} points in the route.`);
                return;
            }

            router.setWaypoints(keys.map(k => L.latLng(...routePoints[k])));

            // –µ—Å–ª–∏ –∫–∞—Ä—Ç–∞ –±—ã–ª–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ —Ç–æ—á–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤ –±–ª–æ–∫–∞
            setTimeout(() => map.invalidateSize(), 150);
        }

        function swapRoute() {
            const a = selectStart.value;
            const b = selectEnd.value;
            selectStart.value = b;
            selectEnd.value = a;
            stops.reverse();
            renderStops();

            if (selectStart.value && selectEnd.value && router.getWaypoints().length) buildRoute();
        }

        function clearRoute() {
            stops.length = 0;
            renderStops();
            router.setWaypoints([]);
            infoBox.style.display = "none";
            infoBox.innerHTML = "";
        }

        // ===== events =====
        btnAddStop?.addEventListener("click", addStop);
        btnBuild?.addEventListener("click", buildRoute);
        btnSwap?.addEventListener("click", swapRoute);
        btnClear?.addEventListener("click", clearRoute);

        renderStops();
    </script>

    <script>
        // ===== –¢–û–õ–¨–ö–û –í–ö–û =====
        // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–æ–≤/—Ä–∞–π–æ–Ω–æ–≤ (–º–æ–∂–µ—à—å —É–¥–∞–ª–∏—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–∏ –ø—É–Ω–∫—Ç—ã).
        const VKO_REGIONS = [
            { key: "oskemen", name: "”®—Å–∫–µ–º–µ–Ω / –£—Å—Ç—å-–ö–∞–º–µ–Ω–æ–≥–æ—Ä—Å–∫", lat: 49.9589, lon: 82.6058 },
            { key: "oskemen", name: "–†–∞—Ö–º–∞–Ω–æ–≤—Å–∫–∏–µ –∫–ª—é—á–∏", lat: 49.53369, lon: 86.50963 },
            { key: "ridder", name: "–†–∏–¥–¥–µ—Ä", lat: 50.3441, lon: 83.5129 },
            { key: "altai", name: "–ê–ª—Ç–∞–π (–ó—ã—Ä—è–Ω–æ–≤—Å–∫)", lat: 48.8315, lon: 84.6068 },
            { key: "serebryansk", name: "–°–µ—Ä–µ–±—Ä—è–Ω—Å–∫", lat: 49.6819, lon: 83.2847 },
            { key: "zaysan", name: "–ó–∞–π—Å–∞–Ω", lat: 47.4666, lon: 84.8714 },
            { key: "kurchum", name: "–ö—É—Ä—á—É–º", lat: 48.5660, lon: 83.6615 },
            { key: "katon", name: "–ö–∞—Ç–æ–Ω-–ö–∞—Ä–∞–≥–∞–π", lat: 49.1753, lon: 85.6032 },
            { key: "markakol", name: "–ú–∞—Ä–∫–∞–∫–æ–ª—å", lat: 48.7411, lon: 85.7777 },
            { key: "shemonaikha", name: "–®–µ–º–æ–Ω–∞–∏—Ö–∞", lat: 50.6297, lon: 81.9065 },
            { key: "glubokoe", name: "–ì–ª—É–±–æ–∫–æ–µ", lat: 50.1450, lon: 82.3110 }
        ];

        const $region = document.getElementById("wxRegion");
        const $meta = document.getElementById("wxMeta");
        const $panel = document.getElementById("wxPanel");
        const $collapse = document.getElementById("wxCollapse");
        const $chev = document.querySelector(".wx-chev");
        const $reload = document.getElementById("wxReload");
        const $days = document.getElementById("wxDays");

        const $uvText = document.getElementById("uvText");
        const $uvSub = document.getElementById("uvSub");
        const $humText = document.getElementById("humText");
        const $feelText = document.getElementById("feelText");
        const $feelSub = document.getElementById("feelSub");
        const $windText = document.getElementById("windText");
        const $windSub = document.getElementById("windSub");
        const $windArrow = document.getElementById("windArrow");
        const $sunset = document.getElementById("sunsetText");
        const $sunSub = document.getElementById("sunSub");
        const $press = document.getElementById("pressText");

        // ===== –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ select =====
        VKO_REGIONS.forEach(r => {
            const o = document.createElement("option");
            o.value = r.key;
            o.textContent = r.name;
            $region.appendChild(o);
        });

        const saved = localStorage.getItem("vko_region");
        if (saved && VKO_REGIONS.some(x => x.key === saved)) $region.value = saved;

        // ===== collapse =====
        function setCollapsed(v) {
            $panel.classList.toggle("is-collapsed", v);
            $collapse.setAttribute("aria-expanded", String(!v));
            if ($chev) $chev.style.transform = v ? "rotate(225deg)" : "rotate(45deg)";
        }
        $collapse.addEventListener("click", () => setCollapsed(!$panel.classList.contains("is-collapsed")));
        setCollapsed(false);

        function clamp01(x) { return Math.max(0, Math.min(1, x)); }

        // ===== —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—É–¥—É–≥–æ–π =====
        function setGauge(cardKey, p) {
            const cardEl = document.querySelector(`.wx-card[data-card="${cardKey}"]`);
            if (!cardEl) return;

            const prog = cardEl.querySelector(".wx-prog");
            const dot = cardEl.querySelector(".wx-dot");
            if (!prog || !dot) return;

            const L = 157; // —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç CSS stroke-dasharray
            const off = L * (1 - clamp01(p));
            prog.style.strokeDashoffset = String(off);

            const deg = 180 * clamp01(p);
            dot.style.transform = `rotate(${deg}deg)`;
        }

        function fmtTime(iso) {
            const d = new Date(iso);
            return d.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" });
        }

        function wmoIcon(code) {
            code = Number(code);
            if (code === 0) return "‚òÄÔ∏è";
            if ([1, 2].includes(code)) return "üå§Ô∏è";
            if (code === 3) return "‚òÅÔ∏è";
            if ([45, 48].includes(code)) return "üå´Ô∏è";
            if ([51, 53, 55, 56, 57].includes(code)) return "üå¶Ô∏è";
            if ([61, 63, 65, 66, 67, 80, 81, 82].includes(code)) return "üåßÔ∏è";
            if ([71, 73, 75, 77, 85, 86].includes(code)) return "üå®Ô∏è";
            if ([95, 96, 99].includes(code)) return "‚õàÔ∏è";
            return "üå•Ô∏è";
        }

        function uvLabel(uv) {
            if (uv < 3) return "Low";
            if (uv < 6) return "Moderate";
            if (uv < 8) return "High";
            return "Very high";
        }

        function dayLabel(isoDate) {
            const d = new Date(isoDate + "T00:00:00");
            return d.toLocaleDateString("en-US", { weekday: "short", day: "2-digit", month: "2-digit" });
        }

        async function loadRegion(key) {
            const r = VKO_REGIONS.find(x => x.key === key) || VKO_REGIONS[0];
            localStorage.setItem("vko_region", r.key);

            $meta.textContent = `–ó–∞–≥—Ä—É–∑–∫–∞: ${r.name}‚Ä¶`;
            $days.innerHTML = "";

            // Open-Meteo (–±–µ–∑ –∫–ª—é—á–∞): current + hourly(uv) + daily(7 –¥–Ω–µ–π)
            const url =
                `https://api.open-meteo.com/v1/forecast` +
                `?latitude=${encodeURIComponent(r.lat)}` +
                `&longitude=${encodeURIComponent(r.lon)}` +
                `&current=temperature_2m,apparent_temperature,relativehumidity_2m,wind_speed_10m,wind_direction_10m,pressure_msl,weather_code` +
                `&hourly=uv_index` +
                `&daily=temperature_2m_max,temperature_2m_min,weather_code,sunrise,sunset,uv_index_max` +
                `&timezone=auto&forecast_days=7`;

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();

                const cur = data.current || {};
                const units = data.current_units || {};
                const daily = data.daily || {};
                const hourly = data.hourly || {};

                // ===== UV (—Ç–µ–∫—É—â–∏–π —á–∞—Å) =====
                let uv = null;
                if (hourly.time && hourly.uv_index && cur.time) {
                    const idx = hourly.time.indexOf(cur.time);
                    if (idx >= 0) uv = Number(hourly.uv_index[idx]);
                }
                if (uv === null && Array.isArray(daily.uv_index_max)) uv = Number(daily.uv_index_max[0]);

                // ===== –∑–Ω–∞—á–µ–Ω–∏—è =====
                const temp = Number(cur.temperature_2m);
                const feel = Number(cur.apparent_temperature);
                const hum = Number(cur.relativehumidity_2m);
                const wind = Number(cur.wind_speed_10m);
                const wdir = Number(cur.wind_direction_10m);
                const press = Number(cur.pressure_msl); // hPa ~ mbar
                const wcode = Number(cur.weather_code);

                // –≤–µ—Ä—Ö–Ω—è—è —Å—Ç—Ä–æ–∫–∞
                const tText = Number.isFinite(temp) ? `${Math.round(temp)}${units.temperature_2m || "¬∞C"}` : "‚Äî";
                $meta.textContent = `${r.name} ‚Ä¢ –°–µ–π—á–∞—Å ${tText} ${wmoIcon(wcode)}`;

                // 1) UV (—à–∫–∞–ª–∞ 0..11)
                if (Number.isFinite(uv)) {
                    $uvText.textContent = uv.toFixed(0);
                    $uvSub.textContent = uvLabel(uv);
                    setGauge("uv", uv / 11);
                } else {
                    $uvText.textContent = "‚Äî";
                    $uvSub.textContent = "‚Äî";
                    setGauge("uv", 0);
                }

                // 2) Humidity
                if (Number.isFinite(hum)) {
                    $humText.textContent = `${Math.round(hum)}%`;
                    setGauge("hum", hum / 100);
                } else {
                    $humText.textContent = "‚Äî";
                    setGauge("hum", 0);
                }

                // 3) Feels like (—à–∫–∞–ª–∞ -40..+40)
                if (Number.isFinite(feel)) {
                    $feelText.textContent = `${Math.round(feel)}${units.apparent_temperature || "¬∞C"}`;
                    $feelSub.textContent = "–∞–ø–ø. —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞";
                    setGauge("feel", (feel + 40) / 80);
                } else {
                    $feelText.textContent = "‚Äî";
                    $feelSub.textContent = "‚Äî";
                    setGauge("feel", 0);
                }

                // 4) Wind + compass
                if (Number.isFinite(wind)) {
                    $windText.textContent = `${Math.round(wind)} ${units.wind_speed_10m || "km/h"}`;
                    $windSub.textContent = Number.isFinite(wdir) ? `–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${Math.round(wdir)}¬∞` : "‚Äî";
                    $windArrow.style.transform = Number.isFinite(wdir) ? `rotate(${Math.round(wdir)}deg)` : "rotate(0deg)";
                } else {
                    $windText.textContent = "‚Äî";
                    $windSub.textContent = "‚Äî";
                    $windArrow.style.transform = "rotate(0deg)";
                }

                // 5) Sunset today
                if (Array.isArray(daily.sunset) && daily.sunset[0]) {
                    $sunset.textContent = fmtTime(daily.sunset[0]);
                    const rise = (daily.sunrise && daily.sunrise[0]) ? fmtTime(daily.sunrise[0]) : "‚Äî";
                    $sunSub.textContent = `–≤–æ—Å—Ö–æ–¥: ${rise}`;
                } else {
                    $sunset.textContent = "‚Äî";
                    $sunSub.textContent = "‚Äî";
                }

                // 6) Pressure (–ø—Ä–∏–º–µ—Ä–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω 980..1050)
                if (Number.isFinite(press)) {
                    $press.textContent = `${Math.round(press)}`;
                    setGauge("press", (press - 980) / (1050 - 980));
                } else {
                    $press.textContent = "‚Äî";
                    setGauge("press", 0);
                }

                // ===== –ü—Ä–æ–≥–Ω–æ–∑ 7 –¥–Ω–µ–π =====
                const t = daily.time || [];
                const tmax = daily.temperature_2m_max || [];
                const tmin = daily.temperature_2m_min || [];
                const dc = daily.weather_code || [];

                for (let i = 0; i < Math.min(7, t.length); i++) {
                    const el = document.createElement("div");
                    el.className = "wx-day";
                    const hi = Math.round(Number(tmax[i]));
                    const lo = Math.round(Number(tmin[i]));
                    el.innerHTML = `
                                                                      <div class="d1">${dayLabel(t[i])}</div>
                                                                      <div class="d2">${lo}¬∞ / ${hi}¬∞</div>
                                                                      <div class="d3">${wmoIcon(dc[i])}</div>
                                                                    `;
                    $days.appendChild(el);
                }

            } catch (err) {
                $meta.textContent = `–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${String(err.message || err)}`;
            }
        }

        $region.addEventListener("change", () => loadRegion($region.value));
        $reload.addEventListener("click", () => loadRegion($region.value));

        // —Å—Ç–∞—Ä—Ç
        loadRegion($region.value || VKO_REGIONS[0].key);
    </script>


    <script>
        (() => {
            const THEME_KEY = "theme";
            const btn = document.getElementById("themeToggle");
            const heroMap = document.getElementById("heroMap");

            const MAP_GREEN = "map.png";
            const MAP_DARK = "map-dark.png";

            function applyThemeFromStorage() {
                const v = localStorage.getItem(THEME_KEY);
                const isGreen = (v === "green");
                document.body.classList.toggle("green", isGreen);
            }

            function setTheme(isGreen) {
                document.body.classList.toggle("green", isGreen);
                localStorage.setItem(THEME_KEY, isGreen ? "green" : "dark");
            }

            function updateHeroMap() {
                if (!heroMap) return;
                const isGreen = document.body.classList.contains("green");
                heroMap.src = isGreen ? MAP_GREEN : MAP_DARK;
            }

            // 1) restore theme + map on first load
            applyThemeFromStorage();
            updateHeroMap();

            // 2) toggle
            btn?.addEventListener("click", () => {
                const isGreen = !document.body.classList.contains("green");
                setTheme(isGreen);
                // map will be updated by observer, –Ω–æ –≤—ã–∑–æ–≤ –ª–∏—à–Ω–∏–º –Ω–µ –±—É–¥–µ—Ç
                updateHeroMap();
            });

            // 3) –µ—Å–ª–∏ —Ç–µ–º–∞ –º–µ–Ω—è–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –∫–æ–¥–æ–º
            const obs = new MutationObserver(updateHeroMap);
            obs.observe(document.body, { attributes: true, attributeFilter: ["class"] });
        })();
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const root = document.getElementById('langSwitch');
            if (!root) return;

            const btn = root.querySelector('.lang-btn');

            function openMenu() {
                root.classList.add('is-open');
                btn.setAttribute('aria-expanded', 'true');
            }

            function closeMenu() {
                root.classList.remove('is-open');
                btn.setAttribute('aria-expanded', 'false');
            }

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const opened = root.classList.contains('is-open');
                if (opened) closeMenu();
                else openMenu();
            });

            // –∫–ª–∏–∫ –≤–Ω–µ ‚Äî –∑–∞–∫—Ä—ã—Ç—å
            document.addEventListener('click', (e) => {
                if (!root.contains(e.target)) closeMenu();
            });

            // ESC ‚Äî –∑–∞–∫—Ä—ã—Ç—å
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeMenu();
            });
        });
    </script>


    <script>
        (() => {
            const STORAGE_KEY = "vko_comments_v1";
            const MAX_ITEMS = 30;

            function escapeText(s) {
                // We will only ever write via textContent, but keep this as a safe helper.
                return String(s ?? "");
            }

            function fmtDate(ts) {
                try {
                    const d = new Date(ts);
                    return d.toLocaleDateString(undefined, { year: "numeric", month: "short", day: "2-digit" });
                } catch { return ""; }
            }

            function loadComments() {
                try {
                    const raw = localStorage.getItem(STORAGE_KEY);
                    const data = raw ? JSON.parse(raw) : [];
                    return Array.isArray(data) ? data : [];
                } catch {
                    return [];
                }
            }

            function saveComments(items) {
                const trimmed = items.slice(0, MAX_ITEMS);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(trimmed));
                return trimmed;
            }

            function stars(n) {
                const x = Math.max(1, Math.min(5, Number(n) || 5));
                return "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".slice(0, x) + "‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(0, 5 - x);
            }

            function render(items) {
                const list = document.getElementById("commentsList");
                const total = document.getElementById("commentsTotal");
                if (!list) return;

                list.innerHTML = "";
                total && (total.textContent = String(items.length));

                if (!items.length) {
                    const empty = document.createElement("div");
                    empty.className = "comment-empty";
                    empty.textContent = "–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º üôÇ";
                    list.appendChild(empty);
                    return;
                }

                items.forEach((it) => {
                    const card = document.createElement("article");
                    card.className = "comment-item";

                    const head = document.createElement("div");
                    head.className = "comment-item-head";

                    const name = document.createElement("div");
                    name.className = "comment-item-name";
                    name.textContent = escapeText(it.name);

                    const meta = document.createElement("div");
                    meta.className = "comment-item-meta";

                    const rating = document.createElement("span");
                    rating.className = "comment-item-rating";
                    rating.textContent = stars(it.rating);

                    const date = document.createElement("span");
                    date.className = "comment-item-date";
                    date.textContent = fmtDate(it.createdAt);

                    meta.appendChild(rating);
                    meta.appendChild(date);

                    head.appendChild(name);
                    head.appendChild(meta);

                    const body = document.createElement("p");
                    body.className = "comment-item-text";
                    body.textContent = escapeText(it.text);

                    card.appendChild(head);
                    card.appendChild(body);
                    list.appendChild(card);
                });
            }

            document.addEventListener("DOMContentLoaded", () => {
                const form = document.getElementById("commentForm");
                const nameEl = document.getElementById("commentName");
                const ratingEl = document.getElementById("commentRating");
                const textEl = document.getElementById("commentText");
                const countEl = document.getElementById("commentCount");
                const clearBtn = document.getElementById("commentsClearBtn");

                let items = loadComments();
                render(items);

                const updateCount = () => {
                    if (!countEl || !textEl) return;
                    countEl.textContent = String((textEl.value || "").length);
                };
                updateCount();
                textEl?.addEventListener("input", updateCount);

                form?.addEventListener("submit", (e) => {
                    e.preventDefault();

                    const name = (nameEl?.value || "").trim();
                    const text = (textEl?.value || "").trim();
                    const rating = Number(ratingEl?.value || 5);

                    if (!name || !text) return;

                    const newItem = {
                        id: crypto?.randomUUID ? crypto.randomUUID() : String(Date.now() + Math.random()),
                        name: name.slice(0, 40),
                        text: text.slice(0, 400),
                        rating: Math.max(1, Math.min(5, rating)),
                        createdAt: Date.now()
                    };

                    items = [newItem, ...items];
                    items = saveComments(items);

                    // reset
                    form.reset();
                    updateCount();
                    render(items);
                });

                clearBtn?.addEventListener("click", () => {
                    localStorage.removeItem(STORAGE_KEY);
                    items = [];
                    render(items);
                    updateCount();
                });
            });
        })();
    </script>

</body>
</html>
